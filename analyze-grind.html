<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Analyze Grind (Beta)</title>
    <script async src="https://docs.opencv.org/4.5.0/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #3A2114;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            text-align: center;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        #status {
            margin-bottom: 20px;
            font-size: 1rem;
            color: #ccc;
        }

        #imageSrc {
            display: none; /* Hidden original image */
        }

        canvas {
            max-width: 100%;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #555;
        }

        .upload-btn {
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            display: inline-block;
            margin-bottom: 20px;
        }

        #fileInput {
            display: none;
        }

        .result-box {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            display: none; /* Hidden until result ready */
        }

        .result-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .back-btn {
            margin-top: 30px;
            color: #ccc;
            text-decoration: none;
            border: 1px solid #ccc;
            padding: 10px 20px;
            border-radius: 20px;
        }
    </style>
</head>
<body>

    <h1>Analyze Grind (Beta)</h1>
    <p id="status">Loading OpenCV...</p>

    <label for="fileInput" class="upload-btn">
        ðŸ“· Take Photo
    </label>
    <input type="file" id="fileInput" accept="image/*" capture="environment">

    <img id="imageSrc" alt="No Image" />
    <canvas id="canvasOutput"></canvas>

    <div class="result-box" id="resultBox">
        <div class="result-title" id="grindResult">Analyzing...</div>
        <p id="grindDetails">Particle Count: 0</p>
        <p style="font-size: 0.8rem; opacity: 0.7;">(Note: Place a coin for scale next time! This is a rough estimate based on pixels.)</p>
    </div>

    <a href="index.html" class="back-btn">Back to Timer</a>

    <script type="text/javascript">
        let cvReady = false;

        function onOpenCvReady() {
            cvReady = true;
            document.getElementById('status').innerText = "Ready to Analyze. Take a close-up photo of spread-out grounds against a plain background.";
        }

        let imgElement = document.getElementById('imageSrc');
        let inputElement = document.getElementById('fileInput');
        
        inputElement.addEventListener('change', (e) => {
            imgElement.src = URL.createObjectURL(e.target.files[0]);
        }, false);

        imgElement.onload = function() {
            if (!cvReady) return;
            analyzeGrind();
        };

        function analyzeGrind() {
            document.getElementById('status').innerText = "Processing...";
            
            // Read image from DOM
            let src = cv.imread(imgElement);
            let dst = new cv.Mat();
            let gray = new cv.Mat();
            
            // Resize for speed (max width 800)
            let scale = 800 / src.cols;
            let dsize = new cv.Size(800, src.rows * scale);
            cv.resize(src, src, dsize, 0, 0, cv.INTER_AREA);

            // Convert to grayscale
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

            // Threshold (Adaptive is better for uneven lighting)
            cv.adaptiveThreshold(gray, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, 11, 2);

            // Find Contours (Particles)
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(dst, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

            // Filter and Measure Particles
            let totalArea = 0;
            let count = 0;
            let areas = [];

            // Visualize contours on original image (Green)
            for (let i = 0; i < contours.size(); ++i) {
                let cnt = contours.get(i);
                let area = cv.contourArea(cnt);
                
                // Filter noise (too small) and huge blobs (shadows)
                if (area > 10 && area < 5000) {
                    areas.push(area);
                    totalArea += area;
                    count++;
                    // Draw contour
                    cv.drawContours(src, contours, i, [0, 255, 0, 255], 1, cv.LINE_8, hierarchy, 0);
                }
            }

            // Calculate Average Size (in pixels squared)
            let avgArea = count > 0 ? totalArea / count : 0;
            
            // Classification Logic (Heuristic based on pixel area at this resolution)
            // Fine: < 50px
            // Medium: 50 - 150px
            // Coarse: > 150px
            let resultText = "Unknown";
            let color = "#ccc";

            if (avgArea < 40) {
                resultText = "Fine (Espresso)";
                color = "#E91E63"; // Pink
            } else if (avgArea < 120) {
                resultText = "Medium (Pour Over)";
                color = "#4CAF50"; // Green
            } else {
                resultText = "Coarse (French Press)";
                color = "#FF9800"; // Orange
            }

            // Display Result
            cv.imshow('canvasOutput', src);
            document.getElementById('status').innerText = "Analysis Complete.";
            document.getElementById('resultBox').style.display = "block";
            document.getElementById('grindResult').innerText = resultText;
            document.getElementById('grindResult').style.color = color;
            document.getElementById('grindDetails').innerText = `Detected ${count} particles.\nAvg Size: ${Math.round(avgArea)} pxÂ²`;

            // Cleanup
            src.delete(); dst.delete(); gray.delete(); contours.delete(); hierarchy.delete();
        }
    </script>
</body>
</html>
